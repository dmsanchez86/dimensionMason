window.require.register("adapters/Canvas",function(a,b){var c;c=function(){function a(a){var b,c;null==a&&(a={}),c=_.defaults(a,this.DEFAULT_OPTIONS),b=$("<canvas>"),b.attr({width:c.width,height:c.height}),$(c.selector).append(b),this.el=b.get(0)}return a.prototype.DEFAULT_OPTIONS={width:480,height:320,selector:"body"},a.prototype.dispose=function(){return this.el.remove()},a}(),b.exports=c}),window.require.register("config",function(a,b){var c,d,e,f;c={seed:1414181350797,fps:20,spriteSheetSource:"images/spritesheet-textured.png",generators:{galaxy:{options:{size:10}},dungeon:{location:"generators/Dungeon",options:{spritesheetOffset:160,size:48}},world:{location:"generators/World",options:{spritesheetOffset:0,maxHeight:7,worldChunkWidth:4,worldChunkHeight:4,chunkTileWidth:12,chunkTileHeight:12}}},tileWidth:32,tileHeight:32,viewportOptions:{width:20,height:15},minimapOptions:{tileWidth:4,tileHeight:4}},f=c.viewportOptions.width*c.tileWidth,e=c.viewportOptions.height*c.tileHeight,d=c.generators.dungeon.options.size,f+=d*c.minimapOptions.tileWidth+10,c.canvasAdapterOptions={width:f,height:e,selector:"#canvas-container"},console.log("Seed ",c.seed),b.exports=c}),window.require.register("generators/Dungeon",function(a,b){var c,d;d=a("utils"),c=function(){function a(a,b,c){var d;this.seed=a,this.options=b,null==c&&(c=!0),ROT.RNG.setSeed(this.seed),d={roomWidth:[3,7],roomHeight:[3,7],dugPercentage:.06,timeLimit:5e3,corridorLength:[3,6]},this.map=new ROT.Map.Rogue(this.options.size,this.options.size),this.tileCache=[],this.tileTypes=[],c&&this.cacheAllTiles()}return a.prototype.getStartPosition=function(){var a;return a=this.map.rooms[0][0],{x:a.x+1,y:a.y+1}},a.prototype.getFinishPosition=function(){var a,b;return b=this.map.getRooms(),a=b[b.length-1],{x:a._x1+1,y:a._y1+1}},a.prototype.getAllCells=function(){return this.tileCache},a.prototype.cacheAllTiles=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;for(this.tileCache=[],this.map.create(function(a,b,c){return c=+!c,void 0===u.tileCache[b]&&(u.tileCache[b]=[]),u.tileCache[b][a]=4*c}),f=h=0,m=this.tileCache.length-1;m>=0?m>=h:h>=m;f=m>=0?++h:--h)for(d=i=0,n=this.tileCache[f].length-1;n>=0?n>=i:i>=n;d=n>=0?++i:--i)if(a=this.tileCache[f][d],4===a)for(g=j=o=f-1,p=f+1;p>=o?p>=j:j>=p;g=p>=o?++j:--j)for(e=k=q=d-1,r=d+1;r>=q?r>=k:k>=r;e=r>=q?++k:--k)0===this.tileCache[g][e]&&(this.tileCache[g][e]=2);for(t=[],f=l=0,s=this.tileCache.length-1;s>=0?s>=l:l>=s;f=s>=0?++l:--l)t.push(function(){var a,e,g;for(g=[],d=a=0,e=this.tileCache[f].length-1;e>=0?e>=a:a>=e;d=e>=0?++a:--a)b=this.tileCache[f][d],c=Math.floor(b/2),void 0===this.tileTypes[c]&&(this.tileTypes[c]=[]),g.push(this.tileTypes[c].push({x:d,y:f}));return g}.call(this));return t},a.prototype.getCell=function(a,b){return this.tileCache[b]&&null!=this.tileCache[b][a]?this.tileCache[b][a]:void 0},a}(),b.exports=c}),window.require.register("generators/World",function(a,b){var c,d;d=a("utils"),c=function(){function a(a,b,c){this.seed=a,this.options=b,null==c&&(c=!0),this.tileCache=[],this.chunkCache=[],this.tileTypes=[],c&&this.cacheAllTiles()}return a.prototype.getStartPosition=function(a){var b,c;return b=this.tileTypes[2],c=Math.floor(d.random(a)*b.length),b[c]},a.prototype.getFinishPosition=function(a){var b,c;return b=this.tileTypes[2],c=Math.floor(d.random(a)*b.length),b[c]},a.prototype.getAllCells=function(){return this.tileCache},a.prototype.cacheAllTiles=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(l=[],i=j=0,k=this.options.worldChunkHeight-1;k>=0?k>=j:j>=k;i=k>=0?++j:--j)l.push(function(){var j,k,l;for(l=[],h=j=0,k=this.options.worldChunkWidth-1;k>=0?k>=j:j>=k;h=k>=0?++j:--j)b=this.getChunk(h,i),l.push(function(){var j,k,l;for(l=[],d=j=0,k=b.length-1;k>=0?k>=j:j>=k;d=k>=0?++j:--j)l.push(function(){var j,k,l;for(l=[],c=j=0,k=b[d].length-1;k>=0?k>=j:j>=k;c=k>=0?++j:--j)f=h*this.options.chunkTileWidth+c,g=i*this.options.chunkTileHeight+d,a=this.getCell(f,g),e=Math.floor(a/2),void 0===this.tileTypes[e]&&(this.tileTypes[e]=[]),l.push(this.tileTypes[e].push({x:f,y:g}));return l}.call(this));return l}.call(this));return l}.call(this));return l},a.prototype.getCell=function(a,b){var c,d,e,f,g,h;return this.tileCache[b]&&null!=this.tileCache[b][a]?this.tileCache[b][a]:(g=Math.floor(a/this.options.chunkTileWidth),h=Math.floor(b/this.options.chunkTileHeight),e=a%this.options.chunkTileWidth,f=b%this.options.chunkTileHeight,d=this.getChunk(g,h),c=Math.floor(d[f][e]*this.options.maxHeight),null==this.tileCache[b]&&(this.tileCache[b]=[]),this.tileCache[b][a]=c,c)},a.prototype.getChunk=function(a,b){var c,d,e,f,g,h;return e=[this.chunkEdgeIndex(a-1,b-1),this.chunkEdgeIndex(a,b-1),this.chunkEdgeIndex(a+1,b-1),this.chunkEdgeIndex(a+2,b-1)],f=[this.chunkEdgeIndex(a-1,b),this.chunkEdgeIndex(a,b),this.chunkEdgeIndex(a+1,b),this.chunkEdgeIndex(a+2,b)],g=[this.chunkEdgeIndex(a-1,b+1),this.chunkEdgeIndex(a,b+1),this.chunkEdgeIndex(a+1,b+1),this.chunkEdgeIndex(a+2,b+1)],h=[this.chunkEdgeIndex(a-1,b+2),this.chunkEdgeIndex(a,b+2),this.chunkEdgeIndex(a+1,b+2),this.chunkEdgeIndex(a+2,b+2)],d=this.options.chunkTileWidth,c=this.options.chunkTileHeight,this.bilinearInterpolate(d,c,e,f,g,h)},a.prototype.chunkEdgeIndex=function(a,b){var c,e,f;return f=this.options.worldChunkWidth,c=this.options.worldChunkHeight,e=this.seed,a=this.clamp(a,f),b=this.clamp(b,c),d.random(b*f+a+e)},a.prototype.bilinearInterpolate=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s;for(g=[],n=p=0,r=b-1;r>=0?r>=p:p>=r;n=r>=0?++p:--p)for(g[n]=[],o=n/b,l=q=0,s=a-1;s>=0?s>=q:q>=s;l=s>=0?++q:--q)m=l/a,h=this.terp(m,c[0],c[1],c[2],c[3]),i=this.terp(m,d[0],d[1],d[2],d[3]),j=this.terp(m,e[0],e[1],e[2],e[3]),k=this.terp(m,f[0],f[1],f[2],f[3]),g[n][l]=this.terp(o,h,i,j,k);return g},a.prototype.terp=function(a,b,c,d,e){var f;return f=.5*(d-b+(2*b-5*c+4*d-e+(3*(c-d)+e-b)*a)*a)*a+c,f=Math.max(0,f),f=Math.min(1,f)},a.prototype.clamp=function(a,b){return(a+b)%b},a}(),b.exports=c}),window.require.register("generators/galaxy",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(){}return a.prototype.getWorldSeed=function(a,b){var c,f;return f=d.generators.galaxy.options.size,a=e.clamp(a,f),b=e.clamp(b,f),c=b*f+a,Math.floor(16777215*e.random(c*d.seed))},a}(),b.exports=new c}),window.require.register("index",function(a){var b,c,d,e,f;b=a("adapters/Canvas"),c=a("views/Stage"),d=a("config"),f=a("utils"),f.loadImages(d.spriteSheetSource,function(){var a,f,g,h;return a=new b(d.canvasAdapterOptions),h=new c(a.el,"scenes/World"),g="scenes/World",f={x:0,y:0},EventBus.dispatch("!scene:load",this,{sceneLocation:g,options:f}),document.onkeydown=e}),e=function(a){return EventBus.dispatch("!key:down",this,a)}}),window.require.register("models/Cavern",function(a,b){var c;c=function(){function a(a,b,c){this.x=a,this.y=b,this.color=c,this.minimapColor={orange:"#bd6727",blue:"#4e62a5",green:"#76b8fa"}[this.color]}return a.prototype.minimapColor="#880000",a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Coin",function(a,b){var c;c=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.minimapColor="#ffff00",a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Creature",function(a,b){var c;c=function(){function a(a,b,c){this.x=a,this.y=b,this.color=c}return a.prototype.minimapColor="#880088",a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Plant",function(a,b){var c;c=function(){function a(a,b,c){this.x=a,this.y=b,this.maturity=c}return a.prototype.minimapColor="#60c62f",a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Portal",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b,c,d,e){this.x=a,this.y=b,this.worldX=c,this.worldY=d,this.color=e,this.minimapColor={blue:"#00ffff",yellow:"#880000"}[e]}return a.prototype.minimapColor="#ff0000",a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Status",function(a,b){var c;c=function(){function a(a,b){this.title=null!=a?a:"",this.description=null!=b?b:""}return a.prototype.setStatus=function(a,b){return this.title=a,this.description=b,this.onChange(this.title,this.description)},a.prototype.onChange=function(){},a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/Tile",function(a,b){var c;c=function(){function a(a,b,c){this.tileIndex=a,this.x=b,this.y=c}return a.prototype.setTileIndex=function(a){return this.tileIndex!==a?(this.tileIndex=a,this.onChangeTileIndex()):void 0},a.prototype.setIndexCallback=function(a){return this.onChangeTileIndex=a},a.prototype.onChangeTileIndex=function(){},a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/TileMap",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function b(b,c){var d;this.spritesheetOffset=b.options.spritesheetOffset,d=a(b.location),this.mapGenerator=new d(c,b.options),this.tileCache={}}return b.prototype.getCell=function(a,b){return a=e.clamp(a,d.worldTileWidth),b=e.clamp(b,d.worldTileHeight),this.mapGenerator.getCell(a,b)},b.prototype.getStartPosition=function(a){return this.mapGenerator.getStartPosition(a)},b.prototype.getFinishPosition=function(a){return this.mapGenerator.getFinishPosition(a)},b.prototype.getAllCells=function(){return this.mapGenerator.getAllCells()},b.prototype.getTileTypes=function(){return this.mapGenerator.tileTypes},b.prototype.getArea=function(a,b,c,f){var g,h,i,j,k,l,m,n,o,p,q;for(g=[],k=Math.floor(a/2),m=Math.floor(b/2),l=n=0,p=b-1;p>=0?p>=n:n>=p;l=p>=0?++n:--n)for(g[l]=[],j=o=0,q=a-1;q>=0?q>=o:o>=q;j=q>=0?++o:--o)h=e.clamp(j-k+c,d.worldTileWidth),i=e.clamp(l-m+f,d.worldTileHeight),g[l][j]=this.getTile(h,i);return g},b.prototype.getTile=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return void 0!==this.tileCache[""+a+"_"+b]?this.tileCache[""+a+"_"+b]:(r=a,s=b,m=this.mapGenerator.getCell(r,s),n=this.mapGenerator.getCell(r+1,s),k=this.mapGenerator.getCell(r,s+1),l=this.mapGenerator.getCell(r+1,s+1),f=m>>1,g=n>>1,d=k>>1,e=l>>1,o=(1&m)+(1&n)+(1&k)+(1&l)+1>>2,p=1&f|(1&g)<<1|(1&d)<<2|(1&e)<<3,i=f+g+d+e>>2,q=p|o<<4|i<<5,j=i<<1|o,c=p-(1&i),h=16*j+c,h+=this.spritesheetOffset,this.tileCache[""+a+"_"+b]=h)},b}(),b.exports=c}),window.require.register("models/Viewport",function(a,b){var c;c=function(){function a(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d,this.discoveredTiles={}}return a.prototype.setPosition=function(a,b){return b!==this.y||a!==this.x?(this.x=a,this.y=b,EventBus.dispatch("!viewport:move",this)):void 0},a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("models/player",function(a,b){var c;c=function(){function a(){this.coins=0,this.visitedWorlds={},this.x=0,this.y=0}return a}(),b.exports=new c}),window.require.register("scenes/Dungeon",function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;o=a("config"),r=a("utils"),m=a("models/Viewport"),n=a("views/Viewport"),l=a("models/TileMap"),f=a("views/EntityManager"),g=a("views/Minimap"),p=a("generators/galaxy"),h=a("models/Portal"),i=a("views/Portal"),c=a("models/Coin"),d=a("views/Coin"),q=a("models/player"),j=a("models/Status"),k=a("views/Status"),e=function(){function a(a){var b,c,d,e,h;this.options=a,this.seed=this.options.seed,o.worldTileWidth=o.generators.dungeon.options.size,o.worldTileHeight=o.generators.dungeon.options.size,this.el=new createjs.Container,this.tileMapModel=new l(o.generators.dungeon,this.seed),c=this.tileMapModel.getStartPosition(this.seed+102),d=c.x,e=c.y,h=o.viewportOptions.width,b=o.viewportOptions.height,this.viewportModel=new m(d,e,h,b),this.viewportView=new n(this.viewportModel,this.tileMapModel),this.el.addChild(this.viewportView.el),this.entityManagerView=new f(this.viewportModel,this.tileMapModel,this.seed),this.createExit(c.x,c.y,this.options.worldX,this.options.worldY),this.createCoins(),this.entityManagerView.createHero(),this.el.addChild(this.entityManagerView.el),this.doShadows&&this.viewportView.addShadowLayer(this.el,4,5),this.minimapView=new g(this.tileMapModel,this.entityManagerView,this.viewportModel,this.doShadows),this.minimapView.el.x=o.viewportOptions.width*o.tileWidth+10,this.minimapView.el.y=0,this.el.addChild(this.minimapView.el),this.statusModel=new j,h=o.worldTileWidth*o.minimapOptions.tileWidth,b=o.viewportOptions.height*o.tileHeight-(o.worldTileHeight*o.minimapOptions.tileHeight+10),this.statusView=new k(this.statusModel,h,b),this.statusView.el.x=o.viewportOptions.width*o.tileWidth+10,this.statusView.el.y=o.worldTileHeight*o.minimapOptions.tileHeight+10,this.el.addChild(this.statusView.el),this.checkStatus(this.viewportModel.x,this.viewportModel.y),EventBus.addEventListener("!key:down",this.onKeyDown,this)}return a.prototype.doShadows=!0,a.prototype.createCoins=function(){var a,b,e,f,g,h;for(this.coinViews=[],f=this.entityManagerView.getTileTypes(2),a=4;a;)g=Math.floor(r.random(+new Date)*f.length),h=f[g],this.entityManagerView.isOccupied(h.x,h.y)||(b=new c(h.x,h.y),e=new d(b,this.viewportModel),this.coinViews.push(e),this.entityManagerView.addEntity(b,e),a-=1);return this.entityManagerView.cacheCanvas()},a.prototype.createExit=function(a,b,c,d){var e;return this.exitModel=new h(a,b,c,d,"blue"),e=new i(this.exitModel,this.viewportModel),this.entityManagerView.addEntity(this.exitModel,e),this.entityManagerView.cacheCanvas()},a.prototype.onKeyDown=function(a,b){var c,d,e,f,g,h,i,j,k,l;switch(h=this.viewportModel.x,i=this.viewportModel.y,b.keyCode){case 37:h=this.viewportModel.x-1,h=r.clamp(h,o.worldTileWidth);break;case 38:i=this.viewportModel.y-1,i=r.clamp(i,o.worldTileHeight);break;case 39:h=this.viewportModel.x+1,h=r.clamp(h,o.worldTileWidth);break;case 40:i=this.viewportModel.y+1,i=r.clamp(i,o.worldTileHeight);break;case 32:if(this.exitModel.x===h&&this.exitModel.y===i)return g="scenes/World",f={x:this.options.worldX,y:this.options.worldY,startPos:{x:this.options.entranceX,y:this.options.entranceY}},void EventBus.dispatch("!scene:load",this,{sceneLocation:g,options:f});for(l=this.coinViews,e=j=0,k=l.length;k>j;e=++j)if(d=l[e],c=d.model,c.x===h&&c.y===i){this.coinViews.splice(e,1),this.entityManagerView.removeEntity(c,d),q.coins+=5;break}}return this.tileMapModel.getAllCells()[i][h]>=4?(this.checkStatus(h,i),this.viewportModel.setPosition(h,i)):void 0},a.prototype.checkStatus=function(a,b){var c,d,e,f,g,h,i;for(i=this.coinViews,d=g=0,h=i.length;h>g;d=++g)if(c=i[d],c.model.x===a&&c.model.y===b)return void this.statusModel.setStatus("You found a coin!","Press [Space] to pick up the coin");return this.exitModel.x===a&&this.exitModel.y===b?(e=p.getWorldSeed(this.options.worldX,this.options.worldY),f=new Chance(e).city(),void this.statusModel.setStatus("Portal back to "+f,"Press [Space] to leave this dungeon")):this.statusModel.setStatus("Dungeon","Use the arrow keys to explore")},a.prototype.dispose=function(){return delete this.tileMapModel,this.doShadows&&this.viewportView.removeShadowLayer(this.el),this.el.removeChild(this.statusView.el),this.statusModel.dispose(),this.statusView.dispose(),this.el.removeChild(this.viewportView.el),this.viewportModel.dispose(),this.viewportView.dispose(),this.el.removeChild(this.entityManagerView.el),this.entityManagerView.dispose(),this.el.removeChild(this.minimapView.el),this.minimapView.dispose(),EventBus.removeEventListener("!key:down",this.onKeyDown,this)},a}(),b.exports=e}),window.require.register("scenes/Loading",function(a,b){var c;c=function(){function a(a,b){var c;this.options=a,this.callbackFn=b,this.el=new createjs.Container,_.bindAll(this,"onTick"),this.el.addEventListener("tick",this.onTick),c=new createjs.Text("Loading...","26px Helvetica","#333333"),c.x=10,c.y=10,this.el.addChild(c),this.timer=void 0}return a.prototype.onTick=function(){var a=this;if(!this.timer)return this.timer=setTimeout(function(){return a.callbackFn(a.options),a.timer=void 0},500)},a.prototype.dispose=function(){return createjs.Ticker.removeEventListener("tick",this.onTick)},a}(),b.exports=c}),window.require.register("scenes/World",function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;u=a("config"),x=a("utils"),r=a("models/Viewport"),s=a("views/Viewport"),q=a("models/TileMap"),i=a("views/EntityManager"),j=a("views/Minimap"),v=a("generators/galaxy"),o=a("models/Status"),p=a("views/Status"),k=a("models/Plant"),l=a("views/Plant"),e=a("models/Coin"),f=a("views/Coin"),c=a("models/Cavern"),d=a("views/Cavern"),g=a("models/Creature"),h=a("views/Creature"),m=a("models/Portal"),n=a("views/Portal"),w=a("models/player"),t=function(){function a(a){var b,c,d,e,f,g;this.options=a,this.seed=v.getWorldSeed(this.options.x,this.options.y),this.worldName=new Chance(this.seed).city(),u.worldTileWidth=u.generators.world.options.worldChunkWidth*u.generators.world.options.chunkTileWidth,u.worldTileHeight=u.generators.world.options.worldChunkHeight*u.generators.world.options.chunkTileHeight,this.el=new createjs.Container,this.tileMapModel=new q(u.generators.world,this.seed),this._seed=this.seed,this.coinViews=[],this.portalModels=[],this.cavernModels=[],d=this.tileMapModel.getStartPosition(this.seed+999999),c=d,this.options.startPos&&(c=this.options.startPos),e=c.x,f=c.y,g=u.viewportOptions.width,b=u.viewportOptions.height,this.viewportModel=new r(e,f,g,b),this.viewportView=new s(this.viewportModel,this.tileMapModel),this.el.addChild(this.viewportView.el),this.entityManagerView=new i(this.viewportModel,this.tileMapModel,this.seed),this.createPortals(d.x,d.y,this.options.x,this.options.y),this.createCaverns(),this.createPlants(),this.createCoins(),this.entityManagerView.createHero(),this.el.addChild(this.entityManagerView.el),this.minimapView=new j(this.tileMapModel,this.entityManagerView,this.viewportModel),this.minimapView.el.x=u.viewportOptions.width*u.tileWidth+10,this.minimapView.el.y=0,this.el.addChild(this.minimapView.el),this.statusModel=new o,g=u.worldTileWidth*u.minimapOptions.tileWidth,b=u.viewportOptions.height*u.tileHeight-(u.worldTileHeight*u.minimapOptions.tileHeight+10),this.statusView=new p(this.statusModel,g,b),this.statusView.el.x=u.viewportOptions.width*u.tileWidth+10,this.statusView.el.y=u.worldTileHeight*u.minimapOptions.tileHeight+10,this.el.addChild(this.statusView.el),this.checkStatus(this.viewportModel.x,this.viewportModel.y),EventBus.addEventListener("!key:down",this.onKeyDown,this)}return a.prototype.onKeyDown=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;switch(j=this.viewportModel.x,k=this.viewportModel.y,b.keyCode){case 37:j-=1,j=x.clamp(j,u.worldTileWidth);break;case 38:k-=1,k=x.clamp(k,u.worldTileHeight);break;case 39:j+=1,j=x.clamp(j,u.worldTileWidth);break;case 40:k+=1,k=x.clamp(k,u.worldTileHeight);break;case 32:for(r=this.cavernModels,f=l=0,o=r.length;o>l;f=++l)if(c=r[f],c.x===j&&c.y===k)return i="scenes/Dungeon",g={worldX:this.options.x,worldY:this.options.y,seed:this.seed+f,entranceX:c.x,entranceY:c.y},void EventBus.dispatch("!scene:load",this,{sceneLocation:i,options:g});for(s=this.portalModels,f=m=0,p=s.length;p>m;f=++m)if(h=s[f],h.x===j&&h.y===k)return i="scenes/World",g={x:h.worldX,y:h.worldY},void EventBus.dispatch("!scene:load",this,{sceneLocation:i,options:g});for(t=this.coinViews,f=n=0,q=t.length;q>n;f=++n)if(e=t[f],d=e.model,d.x===j&&d.y===k){this.coinViews.splice(f,1),this.entityManagerView.removeEntity(d,e),w.coins+=5;break}}return this.tileMapModel.getAllCells()[k][j]>=2?(this.checkStatus(j,k),this.viewportModel.setPosition(j,k)):void 0},a.prototype.createPlants=function(){var a,b,c,d,e,f,g;for(a=this.entityManagerView.getTileTypes(2),d=Math.floor(a.length/16);d;)b=Math.floor(x.random(this._seed++)*a.length),g=a[b],this.entityManagerView.isOccupied(g.x,g.y)||(c=Math.floor(8*x.random(this._seed++)),e=new k(g.x,g.y,c),f=new l(e,this.viewportModel),this.entityManagerView.addEntity(e,f),d-=1);return this.entityManagerView.cacheCanvas()},a.prototype.createCaverns=function(){var a,b,e,f,g,h,i,j,k;for(f=this.entityManagerView.getTileTypes(2),k=["blue","orange","green"],i=0,j=k.length;j>i;i++)e=k[i],g=Math.floor(x.random(this._seed++)*f.length),h=f[g],this.entityManagerView.isOccupied(h.x,h.y)||(a=new c(h.x,h.y,e),b=new d(a,this.viewportModel),this.entityManagerView.addEntity(a,b),this.cavernModels.push(a));return this.entityManagerView.cacheCanvas()},a.prototype.createPortals=function(a,b,c,d){var e,f=this;return e=function(a,b,c,d){var e,g;return a=x.clamp(a,u.worldTileWidth),b=x.clamp(b,u.worldTileHeight),c=x.clamp(c,u.generators.galaxy.options.size),d=x.clamp(d,u.generators.galaxy.options.size),e=new m(a,b,c,d,"yellow"),g=new n(e,f.viewportModel),f.entityManagerView.addEntity(e,g),f.portalModels.push(e)},e(a,b-1,c,d-1,"yellow"),e(a+1,b,c+1,d,"yellow"),e(a,b+1,c,d+1,"yellow"),e(a-1,b,c-1,d,"yellow")},a.prototype.createCoins=function(){var a,b,c,d,g,h;for(h=this.entityManagerView.getTileTypes(1),a=4;a;)d=Math.floor(x.random(+new Date)*h.length),g=h[d],this.entityManagerView.isOccupied(g.x,g.y)||(b=new e(g.x,g.y),c=new f(b,this.viewportModel),this.coinViews.push(c),this.entityManagerView.addEntity(b,c),a-=1);return this.entityManagerView.cacheCanvas()},a.prototype.checkStatus=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(o=this.cavernModels,e=i=0,l=o.length;l>i;e=++i)if(c=o[e],c.x===a&&c.y===b)return void this.statusModel.setStatus("Dungeon Entrance","Press [Space] to explore this dungeon");for(p=this.portalModels,e=j=0,m=p.length;m>j;e=++j)if(f=p[e],f.x===a&&f.y===b)return g=v.getWorldSeed(f.worldX,f.worldY),h=new Chance(g).city(),void this.statusModel.setStatus("Portal to "+h+" ["+f.worldX+","+f.worldY+"]","Press [Space] to travel through this portal");for(q=this.coinViews,e=k=0,n=q.length;n>k;e=++k)if(d=q[e],d.model.x===a&&d.model.y===b)return void this.statusModel.setStatus("You found a coin!","Press [Space] to pick up the coin");return this.statusModel.setStatus("Planet "+this.worldName+" ["+this.options.x+","+this.options.y+"]","Use the arrow keys to explore")},a.prototype.dispose=function(){return delete this.tileMapModel,this.el.removeChild(this.statusView.el),this.statusModel.dispose(),this.statusView.dispose(),this.el.removeChild(this.viewportView.el),this.viewportModel.dispose(),this.viewportView.dispose(),this.el.removeChild(this.entityManagerView.el),this.entityManagerView.dispose(),this.el.removeChild(this.minimapView.el),this.minimapView.dispose(),EventBus.removeEventListener("!key:down",this.onKeyDown,this)},a}(),b.exports=t}),window.require.register("utils",function(a,b){var c,d;c=a("config"),d={clamp:function(a,b){return(a+b)%b},random:function(a){return new RNG(a).uniform()},loadImages:function(a,b){return this.tilesetImg=new Image,this.tilesetImg.onload=b,this.tilesetImg.src=a}},b.exports=d}),window.require.register("views/Cavern",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b){this.model=a,this.viewportModel=b,this.spriteSheet=new createjs.SpriteSheet(this.spriteSheetOptions),this.el=new createjs.Sprite(this.spriteSheet,this.model.color),EventBus.addEventListener("!entityManager:move",this.setPosition,this),this.setPosition()}return a.prototype.spriteSheetOptions={images:[e.tilesetImg],frames:{width:d.tileWidth,height:d.tileHeight},animations:{blue:{frames:[233]},orange:{frames:[235]},green:{frames:[237]}}},a.prototype.setPosition=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return a=Math.floor(this.viewportModel.width/2),b=Math.floor(this.viewportModel.height/2),n=this.viewportModel.x,o=this.viewportModel.y,h=this.model.x,i=this.model.y,r=h-n+a,s=i-o+b,q=d.worldTileWidth,e=Math.floor(q/2),p=d.worldTileHeight,c=Math.floor(p/2),l=0,m=0,h>n+e&&(l-=q),n-e>h&&(l+=q),i>o+c&&(m-=p),o-c>i&&(m+=p),f=r+l,g=s+m,j=f*d.tileWidth,k=g*d.tileHeight,this.el.x=j,this.el.y=k},a.prototype.dispose=function(){return EventBus.removeEventListener("!entityManager:move",this.setPosition,this)},a}(),b.exports=c}),window.require.register("views/Coin",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b){this.model=a,this.viewportModel=b,this.spriteSheet=new createjs.SpriteSheet(this.spriteSheetOptions),this.el=new createjs.Sprite(this.spriteSheet,"first"),EventBus.addEventListener("!entityManager:move",this.setPosition,this),this.setPosition()}return a.prototype.spriteSheetOptions={images:[e.tilesetImg],frames:{width:d.tileWidth,height:d.tileHeight},animations:{first:{frames:[248]}}},a.prototype.setPosition=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return a=Math.floor(this.viewportModel.width/2),b=Math.floor(this.viewportModel.height/2),n=this.viewportModel.x,o=this.viewportModel.y,h=this.model.x,i=this.model.y,r=h-n+a,s=i-o+b,q=d.worldTileWidth,e=Math.floor(q/2),p=d.worldTileHeight,c=Math.floor(p/2),l=0,m=0,h>n+e&&(l-=q),n-e>h&&(l+=q),i>o+c&&(m-=p),o-c>i&&(m+=p),f=r+l,g=s+m,j=f*d.tileWidth,k=g*d.tileHeight,this.el.x=j,this.el.y=k},a.prototype.dispose=function(){return EventBus.removeEventListener("!entityManager:move",this.setPosition,this)},a}(),b.exports=c}),window.require.register("views/Creature",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b){this.model=a,this.viewportModel=b,this.spriteSheet=new createjs.SpriteSheet(this.spriteSheetOptions),this.el=new createjs.Sprite(this.spriteSheet,this.model.color),EventBus.addEventListener("!entityManager:move",this.setPosition,this),this.setPosition()}return a.prototype.spriteSheetOptions={images:[e.tilesetImg],frames:{width:d.tileWidth,height:d.tileHeight},animations:{blue:{frames:[240]},orange:{frames:[284]}}},a.prototype.setPosition=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return a=Math.floor(this.viewportModel.width/2),b=Math.floor(this.viewportModel.height/2),n=this.viewportModel.x,o=this.viewportModel.y,h=this.model.x,i=this.model.y,r=h-n+a,s=i-o+b,q=d.worldTileWidth,e=Math.floor(q/2),p=d.worldTileHeight,c=Math.floor(p/2),l=0,m=0,h>n+e&&(l-=q),n-e>h&&(l+=q),i>o+c&&(m-=p),o-c>i&&(m+=p),f=r+l,g=s+m,j=f*d.tileWidth,k=g*d.tileHeight,this.el.x=j,this.el.y=k},a.prototype.dispose=function(){return EventBus.removeEventListener("!entityManager:move",this.setPosition,this)},a}(),b.exports=c}),window.require.register("views/EntityManager",function(a,b){var c,d,e,f,g;c=a("models/Creature"),d=a("views/Creature"),f=a("config"),g=a("utils"),e=function(){function a(a,b,c){this.viewportModel=a,this.tileMapModel=b,this.el=new createjs.Container,this._seed=c,this.occupiedPositions={},this.entityModels=[],this.entityViews=[],EventBus.addEventListener("!viewport:move",this.onViewportMove,this),this.cacheCanvas()}return a.prototype.createHero=function(){return this.creatureModel=new c(this.viewportModel.x,this.viewportModel.y,"blue"),this.creatureView=new d(this.creatureModel,this.viewportModel),this.creatureModel.skipMinimap=!0,this.addEntity(this.creatureModel,this.creatureView),this.cacheCanvas()},a.prototype.getTileTypes=function(a){var b;return b=this.tileMapModel.getTileTypes(),0===b.length?[]:b[a]},a.prototype.isOccupied=function(a,b){return this.occupiedPositions[""+a+"_"+b]===!0},a.prototype.addEntity=function(a,b){return this.entityModels.push(a),this.entityViews.push(b),this.el.addChild(b.el),this.occupiedPositions[""+a.x+"_"+a.y]=!0},a.prototype.removeEntity=function(a,b){var c;return this.occupiedPositions[""+a.x+"_"+a.y]=!1,this.el.removeChild(b.el),a.dispose(),b.dispose(),c=_.indexOf(this.entityModels,a),this.entityModels.splice(c,1),c=_.indexOf(this.entityViews,b),this.entityViews.splice(c,1)},a.prototype.onViewportMove=function(){return this.creatureModel.x=this.viewportModel.x,this.creatureModel.y=this.viewportModel.y,EventBus.dispatch("!entityManager:move",this),this.cacheCanvas()},a.prototype.cacheCanvas=function(){var a,b;return b=f.viewportOptions.width*f.tileWidth,a=f.viewportOptions.height*f.tileHeight,this.el.cache(0,0,b,a)},a.prototype.dispose=function(){var a,b,c,d,e,f,g,h;for(g=this.entityModels,c=0,e=g.length;e>c;c++)a=g[c],a.dispose();for(h=this.entityViews,d=0,f=h.length;f>d;d++)b=h[d],b.dispose();return EventBus.addEventListener("!viewport:move",this.onViewportMove,this)},a}(),b.exports=e}),window.require.register("views/Minimap",function(a,b){var c,d;d=a("config"),c=function(){function a(a,b,c,e){var f,g;this.tileMapModel=a,this.entityManagerView=b,this.viewportModel=c,this.doShadows=null!=e?e:!1,this.el=new createjs.Container,g=d.minimapOptions.tileWidth*d.worldTileWidth,f=d.minimapOptions.tileHeight*d.worldTileHeight,this.backgroundEl=new createjs.Shape,this.backgroundEl.graphics.beginFill("#000000").drawRect(0,0,g,f),this.backgroundEl.cache(0,0,g,f),this.el.addChild(this.backgroundEl),this.terrainEl=new createjs.Shape,this.buildTileViews(),this.el.addChild(this.terrainEl),this.entityEl=new createjs.Shape,this.el.addChild(this.entityEl),this.shadowEl=new createjs.Shape,this.overlayEl=new createjs.Shape,this.el.addChild(this.overlayEl),this.drawEntityViews(),this.doShadows&&this.drawShadowViews(),this.drawOverlayView(),EventBus.addEventListener("!viewport:move",this.drawView,this)}return a.prototype.drawEntityViews=function(){var a,b,c,e,f,g,h,i,j,k,l;for(c=this.entityManagerView.entityModels,a=this.entityEl,a.graphics.clear(),j=d.minimapOptions.tileWidth,i=d.minimapOptions.tileHeight,h=d.minimapOptions.tileWidth*d.worldTileWidth,g=d.minimapOptions.tileHeight*d.worldTileHeight,k=0,l=c.length;l>k;k++)b=c[k],b.skipMinimap||(e=b.x*j,f=b.y*i,a.graphics.beginFill(b.minimapColor).drawRect(e,f,j,i));return a.cache(0,0,h,g)},a.prototype.buildTileViews=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p;for(g=this.tileMapModel.getAllCells(),h=d.minimapOptions.tileWidth,e=d.minimapOptions.tileHeight,l=m=0,o=g.length-1;o>=0?o>=m:m>=o;l=o>=0?++m:--m)for(k=n=0,p=g[l].length-1;p>=0?p>=n:n>=p;k=p>=0?++n:--n)f=g[l][k],a=["#02b0fa","#e3c486","#00b017","#00b017"][Math.floor(f/2)],i=k*d.minimapOptions.tileWidth,j=l*d.minimapOptions.tileHeight,this.terrainEl.graphics.beginFill(a).drawRect(i,j,h,e);return c=d.minimapOptions.tileWidth*d.worldTileWidth,b=d.minimapOptions.tileHeight*d.worldTileHeight,this.terrainEl.cache(0,0,c,b)},a.prototype.drawShadowViews=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p;j=this.tileMapModel.getAllCells(),k=d.minimapOptions.tileWidth,h=d.minimapOptions.tileHeight,this.shadowEl.graphics.clear(),g=d.minimapOptions.tileWidth*d.worldTileWidth,f=d.minimapOptions.tileHeight*d.worldTileHeight,p=this.viewportModel.discoveredTiles;for(e in p)c=p[e],b=e.split("_"),n=+b[0],o=+b[1],l=n*d.minimapOptions.tileWidth,m=o*d.minimapOptions.tileHeight,i=j[o][n],a="#000000",this.shadowEl.graphics.beginFill(a).drawRect(l,m,k,h);return this.shadowEl.cache(0,0,g,f),this.terrainEl.filters=[new createjs.AlphaMaskFilter(this.shadowEl.cacheCanvas)],this.entityEl.filters=[new createjs.AlphaMaskFilter(this.shadowEl.cacheCanvas)],this.terrainEl.cache(0,0,g,f),this.entityEl.cache(0,0,g,f)},a.prototype.drawView=function(){return this.drawEntityViews(),this.drawOverlayView(),this.doShadows?this.drawShadowViews():void 0},a.prototype.drawOverlayView=function(){var a,b,c,e,f,g,h,i,j,k;return a=this.overlayEl,i=d.viewportOptions.width*d.minimapOptions.tileWidth,g=d.viewportOptions.height*d.minimapOptions.tileHeight,f=Math.floor(i/2),e=Math.floor(g/2),j=this.viewportModel.x*d.minimapOptions.tileWidth-f,k=this.viewportModel.y*d.minimapOptions.tileHeight-e,h=d.worldTileWidth*d.minimapOptions.tileWidth,c=d.worldTileHeight*d.minimapOptions.tileHeight,b=a.graphics,b.clear(),b.setStrokeStyle(2,"square"),b.setStrokeStyle(2,"square"),b.beginStroke("rgba(0, 0, 136, 0.6)"),b.drawRect(j+i/2+1,k+g/2+1,2,2),b.beginStroke("rgba(255, 255, 0, 0.6)"),b.drawRect(j,k,i,g),b.drawRect(j-h,k,i,g),b.drawRect(j-h,k-c,i,g),b.drawRect(j+h,k,i,g),b.drawRect(j+h,k-c,i,g),b.drawRect(j+h,k+c,i,g),b.drawRect(j-h,k+c,i,g),b.drawRect(j,k+c,i,g),b.drawRect(j,k-c,i,g),a.cache(0,0,h,c)},a.prototype.dispose=function(){return EventBus.removeEventListener("!viewport:move",this.drawView,this)},a}(),b.exports=c}),window.require.register("views/Plant",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b){var c;this.model=a,this.viewportModel=b,this.spriteSheet=new createjs.SpriteSheet(this.spriteSheetOptions),c="first second third fourth fifth sixth seventh eighth".split(" ")[this.model.maturity],this.el=new createjs.Sprite(this.spriteSheet,c),EventBus.addEventListener("!entityManager:move",this.setPosition,this),this.setPosition()
}return a.prototype.spriteSheetOptions={images:[e.tilesetImg],frames:{width:d.tileWidth,height:d.tileHeight},animations:{first:{frames:[225]},second:{frames:[226]},third:{frames:[227]},fourth:{frames:[228]},fifth:{frames:[229]},sixth:{frames:[230]},seventh:{frames:[231]},eighth:{frames:[232]}}},a.prototype.setPosition=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return a=Math.floor(this.viewportModel.width/2),b=Math.floor(this.viewportModel.height/2),n=this.viewportModel.x,o=this.viewportModel.y,h=this.model.x,i=this.model.y,r=h-n+a,s=i-o+b,q=d.worldTileWidth,e=Math.floor(q/2),p=d.worldTileHeight,c=Math.floor(p/2),l=0,m=0,h>n+e&&(l-=q),n-e>h&&(l+=q),i>o+c&&(m-=p),o-c>i&&(m+=p),f=r+l,g=s+m,j=f*d.tileWidth,k=g*d.tileHeight,this.el.x=j,this.el.y=k},a.prototype.dispose=function(){return EventBus.removeEventListener("!entityManager:move",this.setPosition,this)},a}(),b.exports=c}),window.require.register("views/Portal",function(a,b){var c,d,e;e=a("utils"),d=a("config"),c=function(){function a(a,b){this.model=a,this.viewportModel=b,this.spriteSheet=new createjs.SpriteSheet(this.spriteSheetOptions),this.el=new createjs.Sprite(this.spriteSheet,this.model.color),EventBus.addEventListener("!entityManager:move",this.setPosition,this),this.setPosition()}return a.prototype.spriteSheetOptions={images:[e.tilesetImg],frames:{width:d.tileWidth,height:d.tileHeight},animations:{blue:{frames:[243],speed:1},yellow:{frames:[246],speed:1}}},a.prototype.setPosition=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;return a=Math.floor(this.viewportModel.width/2),b=Math.floor(this.viewportModel.height/2),n=this.viewportModel.x,o=this.viewportModel.y,h=this.model.x,i=this.model.y,r=h-n+a,s=i-o+b,q=d.worldTileWidth,e=Math.floor(q/2),p=d.worldTileHeight,c=Math.floor(p/2),l=0,m=0,h>n+e&&(l-=q),n-e>h&&(l+=q),i>o+c&&(m-=p),o-c>i&&(m+=p),f=r+l,g=s+m,j=f*d.tileWidth,k=g*d.tileHeight,this.el.x=j,this.el.y=k},a.prototype.dispose=function(){return EventBus.removeEventListener("!entityManager:move",this.setPosition,this)},a}(),b.exports=c}),window.require.register("views/Shadow",function(a,b){var c,d;d=a("config"),c=function(){function a(){this.el=new createjs.Shape,this.setShadow(1,1)}return a.prototype.setShadow=function(a){return this.el.graphics.clear(),0!==a?(this.el.graphics.beginFill("rgba(0, 0, 0, "+a+")"),this.el.graphics.drawRect(0-d.tileWidth/2,0-d.tileHeight/2,d.tileWidth,d.tileHeight)):void 0},a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("views/Stage",function(a,b){var c,d,e;e=a("config"),c=a("scenes/Loading"),d=function(){function b(a){this.el=new createjs.Stage(a),createjs.Ticker.setFPS(e.fps),createjs.Ticker.useRAF=!0,_.bindAll(this,"onTick"),createjs.Ticker.addEventListener("tick",this.onTick),EventBus.addEventListener("!scene:load",this.onSceneLoad,this)}return b.prototype.onSceneLoad=function(a,b){return this.loadScene(b.sceneLocation,b.options)},b.prototype.loadScene=function(b,d){var e,f=this;return this.disposeScene(this.scene),e=new c({sceneLocation:b,options:d},function(b){var c;return f.disposeScene(e),c=a(b.sceneLocation),f.scene=new c(b.options),f.el.addChild(f.scene.el)}),this.el.addChild(e.el)},b.prototype.onTick=function(){return this.el.update()},b.prototype.disposeScene=function(a){return a?(this.el.removeChild(a.el),a.dispose()):void 0},b.prototype.dispose=function(){return this.disposeScene(this.scene),createjs.Ticker.removeEventListener("tick",this.onTick),EventBus.removeEventListener("!scene:load",this.onSceneLoad,this)},b}(),b.exports=d}),window.require.register("views/Status",function(a,b){var c,d;d=a("models/player"),c=function(){function a(a,b,c){this.model=a,this.el=new createjs.Container,this.titleEl=new createjs.Text("Title","26px Helvetica","#333333"),this.titleEl.lineWidth=b,this.el.addChild(this.titleEl),this.descriptionEl=new createjs.Text("some long description that should wrap ","16px Helvetica","#333333"),this.descriptionEl.y=12+this.titleEl.getMeasuredHeight(),this.descriptionEl.lineWidth=b,this.el.addChild(this.descriptionEl),this.inventoryEl=new createjs.Text("Coins: "+d.coins,"16px Helvetica","#333333"),this.inventoryEl.y=c-24,this.el.addChild(this.inventoryEl),_.bindAll(this,"onModelChange"),this.model.onChange=this.onModelChange}return a.prototype.onModelChange=function(a,b){return this.titleEl.text=a,this.descriptionEl.text=b,this.descriptionEl.y=12+this.titleEl.getMeasuredHeight(),this.inventoryEl.text="Coins: "+d.coins},a.prototype.dispose=function(){return this.model.onChange=void 0,this.el.removeChild(this.titleEl),this.el.removeChild(this.descriptionEl)},a}(),b.exports=c}),window.require.register("views/Tile",function(a,b){var c,d,e;d=a("config"),e=a("utils"),c=function(){function a(a,b){var c=this;this.tileModel=a,this.hasShadows=null!=b?b:!1,this.el=new createjs.Bitmap(e.tilesetImg),this.tileModel.setIndexCallback(function(){return c.setTileIndex()}),this.setTileIndex()}return a.prototype.setTileIndex=function(){var a,b,c,e,f,g,h;return e=this.tileModel.tileIndex,g=e%16,h=Math.floor(e/16),c=d.tileWidth,f=d.tileHeight,a=0,b=0,this.el.sourceRect=new createjs.Rectangle(g*f+a,h*c+b,f,c)},a.prototype.dispose=function(){},a}(),b.exports=c}),window.require.register("views/Viewport",function(a,b){var c,d,e,f,g,h;d=a("models/Tile"),e=a("views/Tile"),c=a("views/Shadow"),g=a("config"),h=a("utils"),f=function(){function a(a,b){var c,d,e;this.viewportModel=a,this.tileMapModel=b,this.el=new createjs.Container,this.tileLayerEl=new createjs.Container,this.el.addChild(this.tileLayerEl),this.tileViewLookup={},this.tileModelLookup={},this.buildTileModels(),this.buildTileViews(),e=this.tileViewLookup;for(c in e)d=e[c],this.tileLayerEl.addChild(d.el);EventBus.addEventListener("!viewport:move",this.drawMap,this),this.cacheGraphics()}return a.prototype.addShadowLayer=function(a,b,c){var d,e,f;this.shadowCutoff=b,this.shadowRange=c,this.shadowLayerEl=new createjs.Container,this.shadowViewLookup={},this.buildShadowViews(),f=this.shadowViewLookup;for(d in f)e=f[d],this.shadowLayerEl.addChild(e.el);return EventBus.addEventListener("!viewport:move",this.drawShadows,this),a.addChild(this.shadowLayerEl)},a.prototype.buildShadowViews=function(){var a,b,d,e,f,h,i,j,k,l,m;for(b=Math.floor(g.tileWidth/2),d=Math.floor(g.tileHeight/2),f=this.viewportModel.width+1,a=this.viewportModel.height+1,i=j=0,l=a-1;l>=0?l>=j:j>=l;i=l>=0?++j:--j)for(h=k=0,m=f-1;m>=0?m>=k:k>=m;h=m>=0?++k:--k)e=new c,e.el.x=h*g.tileWidth-b,e.el.y=i*g.tileHeight-d,this.shadowViewLookup[""+h+"_"+i]=e;return this.doShadows()},a.prototype.drawShadows=function(){var a,b,c;c=this.shadowViewLookup;for(a in c)b=c[a],b.setShadow(1,1);return this.doShadows(),this.cacheGraphics()},a.prototype.buildTileViews=function(){var a,b,c,d,f,h,i,j,k,l,m;for(b=Math.floor(g.tileWidth/2),c=Math.floor(g.tileHeight/2),h=this.viewportModel.width+1,a=this.viewportModel.height+1,m=[],j=k=0,l=a-1;l>=0?l>=k:k>=l;j=l>=0?++k:--k)m.push(function(){var a,k,l;for(l=[],i=a=0,k=h-1;k>=0?k>=a:a>=k;i=k>=0?++a:--a)d=this.tileModelLookup[""+i+"_"+j],f=new e(d),f.el.x=d.x*g.tileWidth-b,f.el.y=d.y*g.tileHeight-c,l.push(this.tileViewLookup[""+i+"_"+j]=f);return l}.call(this));return m},a.prototype.buildTileModels=function(){var a,b,c,e,f,g,h,i,j;for(e=this.viewportModel.width,a=this.viewportModel.height,f=this.viewportModel.x,g=this.viewportModel.y,b=this.tileMapModel.getArea(e+1,a+1,f-1,g),j=[],g=h=0,i=b.length-1;i>=0?i>=h:h>=i;g=i>=0?++h:--h)j.push(function(){var a,e,h;for(h=[],f=a=0,e=b[g].length-1;e>=0?e>=a:a>=e;f=e>=0?++a:--a)c=new d(b[g][f],f,g),h.push(this.tileModelLookup[""+f+"_"+g]=c);return h}.call(this));return j},a.prototype.drawMap=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(f=this.viewportModel.width,a=this.viewportModel.height,d=this.viewportModel.x,e=this.viewportModel.y,b=this.tileMapModel.getArea(f+1,a+1,d-1,e),h=i=0,k=b.length-1;k>=0?k>=i:i>=k;h=k>=0?++i:--i)for(g=j=0,l=b[h].length-1;l>=0?l>=j:j>=l;g=l>=0?++j:--j)c=this.tileModelLookup[""+g+"_"+h],c.setTileIndex(b[h][g]);return this.cacheGraphics()},a.prototype.doShadows=function(){var a,b,c,d,e,f,g,h=this;return a=new ROT.FOV.PreciseShadowcasting(function(a,b){var c;return c=h.tileMapModel.getCell(a,b),c>=h.shadowCutoff}),g=this.viewportModel.width,b=this.viewportModel.height,e=this.viewportModel.x,f=this.viewportModel.y,c=e-Math.floor(g/2)-1,d=f-Math.floor(b/2)-1,a.compute(this.viewportModel.x,this.viewportModel.y,this.shadowRange,function(a,b,e,f){var g;return 0!==f&&(h.viewportModel.discoveredTiles[""+a+"_"+b]=!0),a-=c,b-=d,g=h.shadowViewLookup[""+a+"_"+b],null!=g?g.setShadow(1-f,e/h.shadowRange):void 0})},a.prototype.cacheGraphics=function(){var a,b;return b=this.viewportModel.width,a=this.viewportModel.height,this.el.cache(0,0,b*g.tileWidth,a*g.tileHeight)},a.prototype.removeShadowLayer=function(a){var b,c,d,e;EventBus.removeEventListener("!viewport:move",this.drawShadows,this),d=this.tileViewLookup;for(b in d)c=d[b],this.shadowLayerEl.removeChild(c.el);e=this.shadowViewLookup;for(b in e)c=e[b],c.dispose();return a.removeChild(this.shadowLayerEl)},a.prototype.dispose=function(){var a,b,c,d,e,f,g;EventBus.removeEventListener("!viewport:move",this.drawMap,this),d=this.tileViewLookup;for(a in d)c=d[a],this.tileLayerEl.removeChild(c.el);this.el.removeChild(this.tileLayerEl),e=this.tileModelLookup;for(a in e)b=e[a],b.dispose();f=this.tileViewLookup,g=[];for(a in f)c=f[a],g.push(c.dispose());return g},a}(),b.exports=f});